name: upload packages

# Controls when the action will run. 
on:
  # schedual test for nightly build
  schedule:
    - cron: "0 0 * * *"
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Log level'
        required: true
        default: 'Warning'
      upload:
        description: 'upload (none | testpypi | pypi)'
        required: true
        default: 'none'
      branch:
        description: 'branch e.g. (master | releases/x.y) [releases/2.8]'
        required: true
        default: 'releases/2.8'
      runtest:
        description: "Run tests (only turn this off in exceptional circumstances)"
        required: true
        default: true

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # build packages
  build:
    runs-on: [ubuntu-latest]
    steps:
      - name: clone dune branch ${{ github.event.inputs.branch}} and build python packages
        uses: actions/checkout@v2
        run: |
          pip install scikit-build
          ./clone-modules ${{ github.event.inputs.branch }}
      - name: upload artifacts
        uses: actions/upload-artifact@v2
        with:
          name: packages
          path: dist

  # test packages
  test:
    if: ${{ github.event.inputs.runtest }} # && ${{ github.event_name != 'push' }}
    needs: build
    strategy:
        fail-fast: false
        # Note:
        # 1) macOS and python 3.7 is disabled due to linker error
        # 2) macOS does not install petsc4py
        matrix:
            os: [ubuntu-latest, macOS-latest]
            test: [core, extensions]
            python: [3.7,3.9]

    runs-on: ${{ matrix.os }}
    steps:
      - name: setup python ${{ matrix.python }}
        uses: actions/checkout@v2
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python }}
      - name: Install dependencies
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            sudo apt update
            sudo apt install libopenmpi-dev openmpi-bin libsuperlu-dev libsuitesparse-dev petsc-dev paraview python3-paraview gmsh
          elif [ "$RUNNER_OS" == "macOS" ]; then
            brew update
            brew install openmpi superlu suite-sparse paraview gmsh
          fi
        shell: bash
      - name: download artifacts
        uses: actions/download-artifact@v2
        with:
          name: packages
          path: dist
      - name: Setup venv
        run: |
          python3 -m venv dune-env
          source dune-env/bin/activate
          pip install --upgrade pip
          pip install matplotlib scipy pygmsh triangle scikit-build
          if [ "$RUNNER_OS" == "Linux" ]; then
            pip install petsc4py
          fi
        shell: bash
      - name: pip install dune modules
        run: |
          source dune-env/bin/activate
          pip install -v --find-links file://$PWD/dist dune-fem
        shell: bash
      - name: Install extension modules
        if: ${{ matrix.test == 'extensions' }}
        run: |
          source dune-env/bin/activate
          pip install -v --find-links file://$PWD/dist dune-fem-dg dune-vem
        shell: bash
      - name: Setup dune-py
        # macOS fails with python 3.7: Symbol not found: _PyCMethod_New
        if: ${{ matrix.python == '3.9' || matrix.os == 'ubuntu-latest' }}
        run: |
          source dune-env/bin/activate
          pip list
          DUNE_CONTROL_PATH=dune-env setup-dunepy.py --opts=config.opts
          python -m dune.fem tutorial
        shell: bash
      - name: Run tutorial
        # macOS fails with python 3.7: Symbol not found: _PyCMethod_New
        if: ${{ matrix.python == '3.9' || matrix.os == 'ubuntu-latest' }}
        run: |
          source dune-env/bin/activate
          export DUNEPY_DISABLE_PLOTTING=1
          export DUNE_LOG_LEVEL=${{ github.event.inputs.logLevel }}
          cd fem_tutorial
          python ../run-tutorial.py ${{ matrix.test }}
        shell: bash

  # https://github.com/marketplace/actions/pypi-publish
  upload:
    if: ${{ github.event.inputs.upload == 'testpypi' || github.event.inputs.upload == 'pypi' }}
    needs: test
    runs-on: [ubuntu-latest]
    steps:
      - name: download artifacts
        uses: actions/download-artifact@v2
        with:
          name: packages
          path: dist
      - name: Publish package to ${{ github.event.inputs.upload }}
        uses: pypa/gh-action-pypi-publish@release/v1
        if: ${{ github.event.inputs.upload == 'pypi' }} # && ${{ github.event_name != 'push' }}
        with:
          user: __token__
          password: ${{ secrets.PYPI_API_TOKEN }}
      - name: Publish package to ${{ github.event.inputs.upload }}
        uses: pypa/gh-action-pypi-publish@release/v1
        if: ${{ github.event.inputs.upload == 'testpypi' }} # && ${{ github.event_name != 'push' }}
        with:
          user: __token__
          password: ${{ secrets.TEST_PYPI_API_TOKEN }}
          repository_url: https://test.pypi.org/legacy/
